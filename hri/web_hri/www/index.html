<!DOCTYPE html5>
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
<link href="styles.css" media="screen" rel="Stylesheet" type="text/css"/>
<script>

// Communication with the socket server
var SERVER="localhost"
var PORT="9999"

var SERVER_URI = "socket_bridge.php?server=" + SERVER + "&port=" + PORT;
	
var discussion;
var http;
var shouldCreateNewBulle = false;

function init() {
	
	http = new XMLHttpRequest();

	http.onreadystatechange = function() {
		if (http.readyState == 4) {
			res = http.responseText;
			if (res.trim() != "") {
				
				if (shouldCreateNewBulle) {
					discussion.insertBefore(newTextBulle(res, "bulle2"), document.getElementById("active_bulle"));
					discussion.insertBefore(newRobotHead(), document.getElementById("active_bulle"));
				} else {
					getBulle("active_robot_bulle").nodeValue = res;
				}
			}
			shouldCreateNewBulle = false;
		}
	}
	
	setInterval(checkForNewQuestions,500);
	
	
	discussion = document.getElementById("discussion");
	discussion.onkeyup = send;

	discussion.appendChild(newInputBulle("[talk to the robot!]"));
	discussion.lastChild.lastChild.focus();
			
}

getBulle = function(bulle_type) {
		return document.getElementById(bulle_type).firstChild;
	}
	

send_to_socket = function (params) {
	var out = "req=" + params;
	http.open("POST", SERVER_URI, true);
	//Send the proper header information along with the request
	http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	http.setRequestHeader("Connection", "close");
	http.setRequestHeader("Content-length", out.length);
	http.send(out);
}
	
checkForNewQuestions = function() {
		shouldCreateNewBulle = true;
		send_to_socket("whatsnew");
}
	

send = function (event) {
	if(event.keyCode == 13) {
		var text = getBulle("active_bulle").value;
		text = text.substring(0, text.length - 1); //remove the trailing \n

		discussion.removeChild(document.getElementById("active_bulle"));
		discussion.appendChild(newTextBulle(text, "bulle"));
				
		try {			
			//discussion.appendChild(newTextBulle("", "bulle2"));
			shouldCreateNewBulle = true;
			send_to_socket(text);			
			//discussion.appendChild(newRobotHead());		
				
		} catch(e) {
			discussion.appendChild(newTextBulle(e.message, "bulle2"));
			discussion.appendChild(newRobotHead());
		}
		
		discussion.appendChild(newInputBulle());
		discussion.lastChild.lastChild.focus();
		
		discussion.scrollIntoView(false);		
	}
}

function newRobotHead() {
	var robot_img = document.createElement("img");
	robot_img.setAttribute("src", "images/robot.png");
	robot_img.setAttribute("class", "robot");

	return robot_img;
}

function newInputBulle(text) {
	var bulle = document.createElement("div");
	bulle.setAttribute("class", "bulle");
	bulle.setAttribute("id", "active_bulle");
	var textzone = document.createElement("textarea");
	textzone.setAttribute("rows", "2");
	
	if (text) {
		var textnode = document.createTextNode(text);
		textzone.appendChild(textnode);
	}
	bulle.appendChild(textzone);
		
	return bulle;
}

function newTextBulle(text, style) {
	var bulle = document.createElement("div");
	bulle.setAttribute("class", style);
	
	
	var textnode = document.createTextNode(text);
	bulle.appendChild(textnode);
	
	if (style == "bulle2") { //the robot
		if(document.getElementById("active_robot_bulle")) {
			document.getElementById("active_robot_bulle").removeAttribute("id");
		}
		bulle.setAttribute("id", "active_robot_bulle");
	}
		bulle.appendChild(newRobotHead());
	
	return bulle;
}


</script>

</head>
<body onload="init()">
<div id="discussion"></div>
</body>
</html>
